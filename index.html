<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI vs AI Chess</title>
<style>
  body { background:#111; color:#eee; font-family:Arial; }
  #board { width: 480px; margin-top:20px; }
  #debugPanel {
    position: fixed;
    right: 0; top: 0; bottom: 0;
    width: 350px;
    background: #222;
    color: #0f0;
    padding: 10px;
    overflow-y: auto;
    display: none;
    border-left: 2px solid #555;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/chessboard-1.0.0.min.css"/>
</head>
<body>

<h2>GPT-4o-mini vs GPT-4o-mini</h2>
<div id="board"></div>

<div id="debugPanel"></div>

<script>
// ------------------- CONFIG -------------------
const KEY_WHITE = "YOUR_FIRST_API_KEY";
const KEY_BLACK = "YOUR_SECOND_API_KEY";
const MODEL = "gpt-4o-mini";
const MOVE_DELAY = 1000; // 1 second

// ------------------- SETUP -------------------
let chess = new Chess();
let board = Chessboard('board', {
  position: 'start'
});

let debugPanel = document.getElementById("debugPanel");
let debugVisible = false;

document.addEventListener("keydown", (e) => {
  if (e.key === "F7") {
    debugVisible = !debugVisible;
    debugPanel.style.display = debugVisible ? "block" : "none";
  }
});

// -------------- LOGGING (hidden unless F7) ----------------
function logDebug(text) {
  let div = document.createElement("div");
  div.textContent = text;
  debugPanel.appendChild(div);
  debugPanel.scrollTop = debugPanel.scrollHeight;
}

// ------------------- AI MOVE REQUEST -------------------
async function askModel(apiKey, boardFen, history) {
  const prompt = `
You are playing chess. Only respond with a legal SAN move.
Current board FEN: ${boardFen}
Move history: ${history.join(", ")}
Your move:
`.trim();

  logDebug("PROMPT → " + prompt);

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: MODEL,
      messages: [{ role: "user", content: prompt }],
      max_tokens: 20,
      temperature: 0.2
    })
  });

  const data = await response.json();
  let moveText = data?.choices?.[0]?.message?.content?.trim();

  logDebug("RESPONSE ← " + moveText);

  return moveText;
}

// ------------------- MAIN LOOP -------------------
async function playTurn() {
  if (chess.game_over()) {
    logDebug("GAME OVER: " + chess.pgn());
    return;
  }

  const turn = chess.turn(); // 'w' or 'b'
  const apiKey = turn === "w" ? KEY_WHITE : KEY_BLACK;

  const moveText = await askModel(apiKey, chess.fen(), chess.history());

  try {
    chess.move(moveText);
    board.position(chess.fen());
  } catch (err) {
    logDebug("Invalid move by model (" + moveText + "), trying again...");
    return setTimeout(playTurn, MOVE_DELAY);
  }

  setTimeout(playTurn, MOVE_DELAY);
}

playTurn();
</script>

</body>
</html>
