<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI vs AI Chess</title>

<style>
  body { background:#111; color:#eee; font-family:Arial; }

  /* Make sure the board is ALWAYS visible */
  #board {
    width: 480px;
    height: 480px;
    margin-top: 20px;
    background: #333; /* debug visibility */
  }

  #debugPanel {
    position: fixed;
    right: 0; top: 0; bottom: 0;
    width: 350px;
    background: #222;
    color: #0f0;
    padding: 10px;
    overflow-y: auto;
    display: none;
    border-left: 2px solid #555;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboardjs/1.0.0/chessboard-1.0.0.min.css"/>

</head>
<body>

<h2>GPT-4o-mini vs GPT-4o-mini</h2>
<div id="board"></div>
<div id="debugPanel"></div>

<script>
const KEY_WHITE = "YOUR_FIRST_API_KEY";
const KEY_BLACK = "YOUR_SECOND_API_KEY";
const MODEL = "gpt-4o-mini";
const MOVE_DELAY = 1000;

let chess;
let board;
let debugVisible = false;

function logDebug(text) {
  let div = document.createElement("div");
  div.textContent = text;
  document.getElementById("debugPanel").appendChild(div);
  document.getElementById("debugPanel").scrollTop =
    document.getElementById("debugPanel").scrollHeight;
}

/* Toggle debug panel with the "f" key */
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "f") {
    debugVisible = !debugVisible;
    document.getElementById("debugPanel").style.display =
      debugVisible ? "block" : "none";
  }
});

/* AI request */
async function askModel(apiKey, boardFen, history) {
  const prompt = `
You are playing chess. Only respond with a legal SAN move.
FEN: ${boardFen}
Moves: ${history.join(", ")}
Move:
`.trim();

  logDebug("PROMPT → " + prompt);

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + apiKey,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      model: MODEL,
      messages: [{ role: "user", content: prompt }],
      max_tokens: 20,
      temperature: 0.2
    })
  });

  const data = await response.json();
  const move = data?.choices?.[0]?.message?.content?.trim();

  logDebug("RESPONSE ← " + move);
  return move;
}

/* Main turn system */
async function playTurn() {
  if (chess.game_over()) {
    logDebug("GAME OVER");
    return;
  }

  const apiKey = chess.turn() === "w" ? KEY_WHITE : KEY_BLACK;
  const moveText = await askModel(apiKey, chess.fen(), chess.history());

  try {
    chess.move(moveText);
    board.position(chess.fen());
  } catch {
    logDebug("INVALID MOVE: " + moveText + " — retrying");
    return setTimeout(playTurn, MOVE_DELAY);
  }

  setTimeout(playTurn, MOVE_DELAY);
}

/* Initialize AFTER the page loads */
window.onload = function () {
  chess = new Chess();

  board = Chessboard('board', {
    position: 'start'
  });

  /* force a redraw to prevent invisible board bugs */
  setTimeout(() => board.resize(), 50);

  playTurn();
};
</script>

</body>
</html>
